{% extends "inventory/base.html" %}
{% block content %}
<h3>New loan</h3>

{% if role != "admin" %}
  {% if role == "employee" %}
    <div class="alert alert-secondary">
      <b>Borrowing as employee.</b>
      {% if person %}
        This request will be created for: <b>{{ person }}</b>.
      {% else %}
        Your account is not linked to an employee profile yet. Ask admin to link your user to a Person record (or set matching email).
      {% endif %}
    </div>
  {% elif role == "company" %}
    <div class="alert alert-secondary">
      <b>Borrowing as company.</b> Choose office + department.
    </div>
  {% endif %}
{% endif %}

<form method="post" class="mt-3">
  {% csrf_token %}
  {{ form.non_field_errors }}

  {% for field in form.visible_fields %}
    <div class="mb-3">
      <label class="form-label">{{ field.label }}</label>
      {{ field }}
      {% if field.errors %}
        <div class="text-danger small">{{ field.errors|striptags }}</div>
      {% endif %}
      {% if field.help_text %}
        <div class="form-text">{{ field.help_text }}</div>
      {% endif %}
    </div>
  {% endfor %}

  <div class="d-flex gap-2">
    <button class="btn btn-success">Create</button>

    {% if cancel_url %}
      <a href="{% url cancel_url %}" class="btn btn-secondary">Cancel</a>
    {% else %}
      <a href="{% url 'loans_list' %}" class="btn btn-secondary">Cancel</a>
    {% endif %}
  </div>

  
</form>

<script>
  (function () {
    const officeField = document.getElementById("id_office");
    const deskField = document.getElementById("id_desk");
    const personField = document.getElementById("id_person");
    const departmentField = document.getElementById("id_department");
    const targetTypeField = document.querySelector('input[name="target_type"]');
    if (!officeField) {
      return;
    }

    function setupFilteredSelect(selectField) {
      if (!selectField) {
        return () => {};
      }

      const allOptions = Array.from(selectField.options).map((option) => ({
        value: option.value,
        label: option.text,
        officeId: option.dataset.officeId || "",
      }));
      const placeholderLabel = allOptions.find((option) => !option.value)?.label || "---------";

      return function renderOptions() {
        const selectedOfficeId = officeField.value;
        const currentValue = selectField.value;

        selectField.innerHTML = "";
        selectField.appendChild(new Option(placeholderLabel, ""));

        allOptions.forEach((option) => {
          if (!option.value) {
            return;
          }
          if (selectedOfficeId && option.officeId !== selectedOfficeId) {
            return;
          }
          selectField.appendChild(new Option(option.label, option.value));
        });

        const hasCurrentValue = Array.from(selectField.options).some((option) => option.value === currentValue);
        selectField.value = hasCurrentValue ? currentValue : "";
        selectField.disabled = !selectedOfficeId;
      };
    }

    const renderDeskOptions = setupFilteredSelect(deskField);

    function renderAll() {
      renderDeskOptions();
    }

    function setDepartmentFromPerson() {
      if (!personField || !departmentField) {
        return;
      }
      const selected = personField.options[personField.selectedIndex];
      const department = selected ? (selected.dataset.department || "") : "";
      if (!department) {
        return;
      }
      if (departmentField.tagName === "INPUT") {
        departmentField.value = department;
        return;
      }
      // Try direct match first
      departmentField.value = department;
      if (departmentField.value === department) {
        return;
      }
      const normalized = department.trim().toLowerCase();
      const match = Array.from(departmentField.options).find(
        (opt) => opt.value.trim().toLowerCase() === normalized || opt.text.trim().toLowerCase() === normalized
      );
      if (match) {
        departmentField.value = match.value;
        return;
      }
      // Fallback: add missing option
      const opt = new Option(department, department, true, true);
      departmentField.add(opt);
    }

    function toggleDepartmentField() {
      if (!departmentField || !targetTypeField) {
        return;
      }
      const checked = document.querySelector('input[name="target_type"]:checked');
      const target = checked ? checked.value : "";
      if (target === "person") {
        setDepartmentFromPerson();
      } else if (target === "office") {
        departmentField.value = "";
      }
      if (departmentField.tagName === "SELECT") {
        departmentField.disabled = true;
      }
    }

    officeField.addEventListener("change", renderAll);
    renderAll();
    if (personField) {
      personField.addEventListener("change", () => {
        setDepartmentFromPerson();
        toggleDepartmentField();
      });
    }
    document.querySelectorAll('input[name="target_type"]').forEach((el) => {
      el.addEventListener("change", toggleDepartmentField);
    });
    toggleDepartmentField();
  })();
</script>
{% endblock %}
