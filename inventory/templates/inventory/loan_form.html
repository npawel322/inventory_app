{% extends "inventory/base.html" %}
{% block content %}
<h3>New loan</h3>

{% if role != "admin" %}
  {% if role == "employee" %}
    <div class="alert alert-secondary">
      <b>Borrowing as employee.</b>
      {% if person %}
        This request will be created for: <b>{{ person }}</b>.
      {% else %}
        Your account is not linked to an employee profile yet. Ask admin to link your user to a Person record (or set matching email).
      {% endif %}
    </div>
  {% elif role == "company" %}
    <div class="alert alert-secondary">
      <b>Borrowing as company.</b> Choose office + department.
    </div>
  {% endif %}
{% endif %}

<form method="post" class="mt-3">
  {% csrf_token %}
  {{ form.non_field_errors }}

  {% for field in form.visible_fields %}
    <div class="mb-3">
      <label class="form-label">{{ field.label }}</label>
      {{ field }}
      {% if field.errors %}
        <div class="text-danger small">{{ field.errors|striptags }}</div>
      {% endif %}
      {% if field.help_text %}
        <div class="form-text">{{ field.help_text }}</div>
      {% endif %}
    </div>
  {% endfor %}

  <div class="d-flex gap-2">
    <button class="btn btn-success">Create</button>

    {% if cancel_url %}
      <a href="{% url cancel_url %}" class="btn btn-secondary">Cancel</a>
    {% else %}
      <a href="{% url 'loans_list' %}" class="btn btn-secondary">Cancel</a>
    {% endif %}
  </div>

  
</form>

<script>
  (function () {
    const officeField = document.getElementById("id_office");
    const deskField = document.getElementById("id_desk");
    const departmentField = document.getElementById("id_department_position");

    if (!officeField) {
      return;
    }

    function setupFilteredSelect(selectField) {
      if (!selectField) {
        return () => {};
      }

      const allOptions = Array.from(selectField.options).map((option) => ({
        value: option.value,
        label: option.text,
        officeId: option.dataset.officeId || "",
      }));
      const placeholderLabel = allOptions.find((option) => !option.value)?.label || "---------";

      return function renderOptions() {
        const selectedOfficeId = officeField.value;
        const currentValue = selectField.value;

        selectField.innerHTML = "";
        selectField.appendChild(new Option(placeholderLabel, ""));

        allOptions.forEach((option) => {
          if (!option.value) {
            return;
          }
          if (selectedOfficeId && option.officeId !== selectedOfficeId) {
            return;
          }
          selectField.appendChild(new Option(option.label, option.value));
        });

        const hasCurrentValue = Array.from(selectField.options).some((option) => option.value === currentValue);
        selectField.value = hasCurrentValue ? currentValue : "";
        selectField.disabled = !selectedOfficeId;
      };
    }

    const renderDeskOptions = setupFilteredSelect(deskField);
    const renderDepartmentOptions = setupFilteredSelect(departmentField);

    function renderAll() {
      renderDeskOptions();
      renderDepartmentOptions();
    }

    officeField.addEventListener("change", renderAll);
    renderAll();
  })();
</script>
{% endblock %}
