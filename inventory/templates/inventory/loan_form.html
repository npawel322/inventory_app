{% extends "inventory/base.html" %}
{% block content %}

<h3>New loan</h3>

{% if role != "admin" %}
  {% if role == "employee" %}
    <div class="alert alert-secondary">
      <b>Borrowing as employee.</b>
      {% if person %}
        This request will be created for: <b>{{ person }}</b>.
      {% else %}
        Your account is not linked to an employee profile yet.
        Ask admin to link your user to a Person record (or set matching email).
      {% endif %}
    </div>
  {% elif role == "company" %}
    <div class="alert alert-secondary">
      <b>Borrowing as company.</b> Choose office.
    </div>
  {% endif %}
{% endif %}

<form method="post" class="mt-3">
  {% csrf_token %}
  {{ form.non_field_errors }}

  {% for field in form.visible_fields %}
    <div class="mb-3">
      <label class="form-label">{{ field.label }}</label>
      {{ field }}

      {% if field.errors %}
        <div class="text-danger small">{{ field.errors|striptags }}</div>
      {% endif %}

      {% if field.help_text %}
        <div class="form-text">{{ field.help_text }}</div>
      {% endif %}
    </div>
  {% endfor %}

  <div class="d-flex gap-2">
    <button class="btn btn-success">Create</button>

    {% if cancel_url %}
      <a href="{% url cancel_url %}" class="btn btn-secondary">Cancel</a>
    {% else %}
      <a href="{% url 'loans_list' %}" class="btn btn-secondary">Cancel</a>
    {% endif %}
  </div>
</form>

<script>
  (function () {
    const officeField = document.getElementById("id_office");
    const deskField = document.getElementById("id_desk");
    const departmentPosField = document.getElementById("id_department_position");

    // Admin-only fields (may not exist for employee/company forms)
    const personField = document.getElementById("id_person");
    const departmentField = document.getElementById("id_department");

    function groupOf(el) {
      return el ? el.closest(".mb-3") : null;
    }

    const personGroup = groupOf(personField);
    const departmentGroup = groupOf(departmentField);
    const deskGroup = groupOf(deskField);

    // --- filtering select by office (desk + optional dept_position) ---
    function setupFilteredSelect(selectField, datasetKey) {
      if (!selectField || !officeField) return () => {};

      const allOptions = Array.from(selectField.options).map((opt) => ({
        value: opt.value,
        label: opt.text,
        officeId: opt.dataset && opt.dataset[datasetKey] ? opt.dataset[datasetKey] : "",
        isPlaceholder: !opt.value,
      }));

      const placeholder = allOptions.find((o) => o.isPlaceholder) || { label: "---------", value: "" };

      return function renderOptions() {
        const selectedOfficeId = officeField.value;
        const currentValue = selectField.value;

        selectField.innerHTML = "";
        selectField.appendChild(new Option(placeholder.label, ""));

        allOptions.forEach((o) => {
          if (o.isPlaceholder) return;
          if (selectedOfficeId && o.officeId !== selectedOfficeId) return;

          const opt = new Option(o.label, o.value);
          opt.dataset[datasetKey] = o.officeId; // keep dataset for future filtering
          selectField.appendChild(opt);
        });

        const stillExists = Array.from(selectField.options).some((opt) => opt.value === currentValue);
        selectField.value = stillExists ? currentValue : "";
        selectField.disabled = !selectedOfficeId;
      };
    }

    const renderDeskOptions = setupFilteredSelect(deskField, "officeId");
    const renderDepartmentOptions = setupFilteredSelect(departmentPosField, "officeId");

    function renderAll() {
      renderDeskOptions();
      renderDepartmentOptions();
    }

    // --- admin: target_type toggling (hide/disable person + department) ---
    function getTargetType() {
      const checked = document.querySelector('input[name="target_type"]:checked');
      return checked ? checked.value : "";
    }

    function setDepartmentFromPerson() {
      if (!personField || !departmentField) return;

      const selected = personField.options[personField.selectedIndex];
      const dept = selected ? (selected.dataset.department || "") : "";

      departmentField.value = dept || "";
      departmentField.readOnly = true;
    }

    function hideAndDisable(el, group) {
      if (group) group.style.display = "none";
      if (el) {
        el.disabled = true;
        el.value = "";
      }
    }

    function showAndEnable(el, group) {
      if (group) group.style.display = "";
      if (el) el.disabled = false;
    }

    function toggleByTargetType() {
  const t = getTargetType();

  if (!officeField) return;

  if (t === "person") {
    // person loan → everything visible
    showAndEnable(personField, personGroup);
    showAndEnable(deskField, deskGroup);
    showAndEnable(departmentField, departmentGroup);

    setDepartmentFromPerson();
  }

  if (t === "office") {
    // office loan → ONLY office
    hideAndDisable(personField, personGroup);
    hideAndDisable(deskField, deskGroup);
    hideAndDisable(departmentField, departmentGroup);
  }
}


    // events
    if (officeField) {
      officeField.addEventListener("change", renderAll);
    }
    if (personField) {
      personField.addEventListener("change", () => {
        setDepartmentFromPerson();
      });
    }
    document.querySelectorAll('input[name="target_type"]').forEach((el) => {
      el.addEventListener("change", toggleByTargetType);
    });

    // init
    renderAll();
    toggleByTargetType();
  })();
</script>

{% endblock %}
