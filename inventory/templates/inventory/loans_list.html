{% extends "inventory/base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center">
  <h3>{% if is_admin %}Active loans{% else %}My active loans{% endif %}</h3>
  <a class="btn btn-primary" href="{% url 'loan_create' %}">+ New loan</a>
</div>

<table class="table table-striped mt-3">
  <tr>
    <th>Asset</th>
    <th>Office</th>
    <th>Desk</th>
    <th>Department</th>
    <th>Target</th>
    <th>
      Issue date
      {% if sort_field == "issue" %}
        {% if sort_dir == "asc" %}
          <a class="text-decoration-none" href="?sort=issue&dir=desc">&uarr;</a>
        {% else %}
          <a class="text-decoration-none" href="?sort=issue&dir=asc">&darr;</a>
        {% endif %}
      {% else %}
        <a class="text-decoration-none" href="?sort=issue&dir=asc">&uarr;</a>
      {% endif %}
    </th>
    <th>
      Due
      {% if sort_field == "due" %}
        {% if sort_dir == "asc" %}
          <a class="text-decoration-none" href="?sort=due&dir=desc">&uarr;</a>
        {% else %}
          <a class="text-decoration-none" href="?sort=due&dir=asc">&darr;</a>
        {% endif %}
      {% else %}
        <a class="text-decoration-none" href="?sort=due&dir=asc">&uarr;</a>
      {% endif %}
    </th>
    <th></th>
  </tr>
  {% for l in loans %}
    <tr class="{% if l.due_date and l.due_date < today %}table-danger{% endif %}">
      <td>{{ l.asset }}</td>
      <td>{{ l.office_label }}</td>
      <td>{{ l.desk_label }}</td>
      <td>{{ l.department_label }}</td>
      <td>{{ l.target_label }}</td>
      <td>{{ l.loan_date }}</td>
      <td>{{ l.due_date|default:"-" }}</td>
      <td>
  {% if is_admin or l.created_by_id == request.user.id or l.person and l.person.user_id == request.user.id %}
          <form method="post" action="{% url 'loan_return' l.id %}">
            {% csrf_token %}
            <button class="btn btn-sm btn-success">Return</button>
          </form>
        {% endif %}
      </td>
    </tr>
  {% empty %}
    <tr><td colspan="8" class="text-muted">No active loans.</td></tr>
  {% endfor %}
</table>
{% endblock %}
